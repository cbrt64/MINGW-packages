# Contributor: Edward E <develinthedetail@gmail.com>

#_variant=-static
_variant=-shared

_realname=krita
pkgbase=mingw-w64-${_realname}
pkgname="${MINGW_PACKAGE_PREFIX}-${_realname}"
pkgver=4.2.5
pkgrel=1
pkgdesc="A free digital painting application (mingw-w64)"
arch=('any')
url="https://www.krita.org/"
license=('GPL3')
depends=("${MINGW_PACKAGE_PREFIX}-fftw"
         "${MINGW_PACKAGE_PREFIX}-gsl"
         "${MINGW_PACKAGE_PREFIX}-LibRaw"
         "${MINGW_PACKAGE_PREFIX}-opencolorio"
         "${MINGW_PACKAGE_PREFIX}-boost"
         "${MINGW_PACKAGE_PREFIX}-exiv2"
         "${MINGW_PACKAGE_PREFIX}-openexr"
         "${MINGW_PACKAGE_PREFIX}-poppler"
#         "${MINGW_PACKAGE_PREFIX}-kio"
         "${MINGW_PACKAGE_PREFIX}-hicolor-icon-theme"
         "${MINGW_PACKAGE_PREFIX}-libheif"
         "${MINGW_PACKAGE_PREFIX}-desktop-file-utils"
         "${MINGW_PACKAGE_PREFIX}-shared-mime-info"
         "${MINGW_PACKAGE_PREFIX}-quazip"
         "${MINGW_PACKAGE_PREFIX}-karchive-qt5"
         "${MINGW_PACKAGE_PREFIX}-kconfig-qt5"
         "${MINGW_PACKAGE_PREFIX}-kwidgetsaddons-qt5"
         "${MINGW_PACKAGE_PREFIX}-kcompletion-qt5"
         "${MINGW_PACKAGE_PREFIX}-kcoreaddons-qt5"
         "${MINGW_PACKAGE_PREFIX}-kguiaddons-qt5"
         "${MINGW_PACKAGE_PREFIX}-ki18n-qt5"
         "${MINGW_PACKAGE_PREFIX}-kitemmodels-qt5"
         "${MINGW_PACKAGE_PREFIX}-kitemviews-qt5"
         "${MINGW_PACKAGE_PREFIX}-kwindowsystem-qt5"
         )
makedepends=("${MINGW_PACKAGE_PREFIX}-extra-cmake-modules"
             "git"
             "${MINGW_PACKAGE_PREFIX}-boost"
#             "${MINGW_PACKAGE_PREFIX}-vc"
             "${MINGW_PACKAGE_PREFIX}-python3"
             "${MINGW_PACKAGE_PREFIX}-eigen3"
             )
conflicts=("${MINGW_PACKAGE_PREFIX}-krita-git")
install=krita-${CARCH}.install
source=(https://download.kde.org/stable/${_realname}/${pkgver}/${_realname}-${pkgver}.tar.xz{,.sig}
        "001-fix-mingw-w64-identifier-collision.patch")
sha256sums=('213fdd3cbf2a2b21e2c208bfb422067888b3741780cd34749c63875f58a41f59'
            'SKIP'
            '6502e88fef96124b7d4083f271826316ae65e4af9110cfca1ef5ae45d6324bef')

prepare() {
  cd "${srcdir}"/${_realname}-${pkgver}

  patch -p1 -i "${srcdir}"/001-fix-mingw-w64-identifier-collision.patch
}

build() {
  local -a extra_config
  mkdir -p build-${CARCH}${_variant}
  cd build-${CARCH}${_variant}
  if [ "${_variant}" = "-static" ]; then
    extra_config+=( -DBUILD_SHARED_LIBS=NO )
    QT5_PREFIX=${MINGW_PREFIX}/qt5-static
    export PATH=${QT5_PREFIX}/bin:"$PATH"
  else
    QT5_PREFIX=${MINGW_PREFIX}
  fi
  if check_option "debug" "n"; then
    extra_config+=("-DCMAKE_BUILD_TYPE=Release")
  else
    extra_config+=("-DCMAKE_BUILD_TYPE=Debug")
  fi

MSYS2_ARG_CONV_EXCL="-DCMAKE_INSTALL_PREFIX=;-DECM_MKSPECS_INSTALL_DIR;-DQt5_DIR=;-DECM_DIR=" \
  cmake ../${_realname}-${pkgver} \
    -DCMAKE_INSTALL_PREFIX=${QT5_PREFIX} \
    -DLIB_INSTALL_DIR=lib \
    -DECM_MKSPECS_INSTALL_DIR=${QT5_PREFIX} \
    -DQt5_DIR=${QT5_PREFIX}/lib/cmake/Qt5 \
    -DBUILD_TESTING=OFF \
    -DECM_DIR=${MINGW_PREFIX}/share/ECM \
    "${extra_config[@]}" \
    -G'MSYS Makefiles'
  make
}

package() {
  cd build-${CARCH}${_variant}
  make DESTDIR="${pkgdir}" install
}
